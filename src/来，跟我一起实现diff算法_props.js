import projectConfig from '/In-depth-analysis-of-Vue/pagic.config.js';
export default {
    'prev': undefined,
    'next': undefined,
    config: { "root": "/", ...projectConfig, branch: 'pagic' },
    'pagePath': "src/来，跟我一起实现diff算法.md",
    'layoutPath': "_layout.tsx",
    'outputPath': "src/来，跟我一起实现diff算法.html",
    'title': undefined,
    'content': React.createElement("article", { dangerouslySetInnerHTML: {
            __html: '<blockquote>\n<p>这一节，依然是<strong>深入剖析Vue源码系列</strong>，上几节内容介绍了<code>Virtual DOM</code>是Vue在渲染机制上做的优化，而渲染的核心在于数据变化时，如何高效的更新节点，这就是diff算法。由于源码中关于<code>diff</code>算法部分流程复杂，直接剖析每个流程不易于理解，所以这一节我们换一个思路，参考源码来手动实现一个简易版的<code>diff</code>算法。</p>\n</blockquote>\n<p>之前讲到<code>Vue</code>在渲染机制的优化上，引入了<code>Virtual DOM</code>的概念，利用<code>Virtual DOM</code>描述一个真实的<code>DOM</code>,本质上是在<code>JS</code>和真实<code>DOM</code>之间架起了一层缓冲层。当我们通过大量的<code>JS</code>运算,并将最终结果反应到浏览器进行渲染时，<code>Virtual DOM</code>可以将多个改动合并成一个批量的操作，从而减少 <code>dom</code> 重排的次数，进而缩短了生成渲染树和绘制节点所花的时间，达到渲染优化的目的。之前的章节，我们简单的介绍了<code>Vue</code>中<code>Vnode</code>的概念，以及创建<code>Vnode</code>到<code>渲染Vnode</code>再到真实<code>DOM</code>的过程。如果有忘记流程的，可以参考前面的章节分析。</p>\n<p>**从<code>render</code>函数到创建虚拟<code>DOM</code>,再到渲染真实节点，这一过程是完整的，也是容易理解的。然而引入虚拟<code>DOM</code>的核心不在这里，而在于当数据发生变化时，如何最优化数据变动到视图更新的过程。这一个过程才是<code>Vnode</code>更新视图的核心，也就是常说的<code>diff</code>算法。**下面跟着我来实现一个简易版的<code>diff</code>算法</p>\n<h2 id="81-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E7%B1%BB">8.1 创建基础类<a class="anchor" href="#81-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E7%B1%BB">§</a></h2>\n<p>代码编写过程会遇到很多基本类型的判断，第一步需要先将这些方法封装。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Util</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token comment">// 检测基础类型</span>\n  <span class="token function">_isPrimitive</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'number\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'symbol\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'boolean\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 判断值不为空</span>\n  <span class="token function">_isDef</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> v <span class="token operator">!==</span> <span class="token keyword nil">undefined</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">!==</span> <span class="token keyword null nil">null</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 工具类的使用</span>\n<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Util</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre>\n<h2 id="82-%E5%88%9B%E5%BB%BAvnode">8.2 创建Vnode<a class="anchor" href="#82-%E5%88%9B%E5%BB%BAvnode">§</a></h2>\n<p><code>Vnode</code>这个类在之前章节已经分析过源码，本质上是用一个对象去描述一个真实的<code>DOM</code>元素，简易版关注点在于元素的<code>tag</code>标签，元素的属性集合<code>data</code>,元素的子节点<code>children</code>,<code>text</code>为元素的文本节点,简单的描述类如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">=</span> tag<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">=</span> children<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">=</span> <span class="token string">\'\'</span>\n    <span class="token comment">// text属性用于标志Vnode节点没有其他子节点，只有纯文本</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isPrimitive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">:</span> <span class="token string">\'\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="83-%E6%A8%A1%E6%8B%9F%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B">8.3 模拟渲染过程<a class="anchor" href="#83-%E6%A8%A1%E6%8B%9F%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B">§</a></h2>\n<p>接下来需要创建另一个类模拟将<code>render</code>函数转换为<code>Vnode</code>,并将<code>Vnode</code>渲染为真实<code>DOM</code>的过程，我们将这个类定义为<code>Vn</code>,<code>Vn</code>具有两个基本的方法<code>createVnode, createElement</code>, 分别实现创建虚拟<code>Vnode</code>,和创建真实<code>DOM</code>的过程。</p>\n<h3 id="831-createvnode">8.3.1 createVnode<a class="anchor" href="#831-createvnode">§</a></h3>\n<p><code>createVnode</code>模拟<code>Vue</code>中<code>render</code>函数的实现思路，目的是将数据转换为虚拟的<code>Vnode</code>,先看具体的使用和定义。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// index.html</span>\n\n<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"diff.js"</span><span class="token operator">></span>\n<span class="token operator">&lt;</span>script<span class="token operator">></span>\n\n<span class="token comment">// 创建Vnode</span>\n\n<span class="token keyword">let</span> <span class="token function-variable function">createVnode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> _c <span class="token operator">=</span> vn<span class="token punctuation">.</span><span class="token property-access">createVnode</span><span class="token punctuation">;</span>\n  <span class="token keyword control-flow">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">\'test\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token arrow operator">=></span> <span class="token function">_c</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 元素内容结构</span>\n<span class="token keyword">let</span> arr <span class="token operator">=</span> \n  <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'span\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">3</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'strong\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">4</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>\n\n\n\n<span class="token comment">// diff.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token comment">// 创建虚拟Vnode</span>\n    <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  global<span class="token punctuation">.</span><span class="token property-access">vn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n</code></pre>\n<p>这是一个完整的<code>Vnode</code>对象，我们已经可以用这个对象来简单的描述一个<code>DOM</code>节点，而<code>createElement</code>就是将这个对象对应到真实节点的过程。最终我们希望的结果是这样的。</p>\n<p><strong>Vnode对象</strong></p>\n<p><img src="./img/8.1.png" alt=""></p>\n<p><strong>渲染结果</strong></p>\n<p><img src="./img/8.2.png" alt=""></p>\n<h3 id="832-createelement">8.3.2 createElement<a class="anchor" href="#832-createelement">§</a></h3>\n<p>渲染真实<code>DOM</code>的过程就是遍历<code>Vnode</code>对象，递归创建真实节点的过程，这个不是本文的重点，所以我们可以粗糙的实现。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> el <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>el <span class="token operator">||</span> <span class="token operator">!</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">\'无法找到根节点\'</span><span class="token punctuation">)</span>\n      <span class="token keyword">let</span> <span class="token function-variable function">_createElement</span> <span class="token operator">=</span> <span class="token parameter">vnode</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 添加属性</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setAttr</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 简单的文本节点，只要创建文本节点即可</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isPrimitive</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> testEle <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>testEle<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 复杂的子节点需要遍历子节点递归创建节点。</span>\n          children<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">_createElement</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword control-flow">return</span> ele\n      <span class="token punctuation">}</span>\n      <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">_createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="833-setattr">8.3.3 setAttr<a class="anchor" href="#833-setattr">§</a></h3>\n<p><code>setAttr</code>是为节点设置属性的方法，利用<code>DOM</code>原生的<code>setAttribute</code>为每个节点设置属性值。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">setAttr</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>\n    <span class="token keyword">const</span> attrs <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">attrs</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attrs<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>\n    <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n      el<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>至此一个简单的 **数据 -&gt; <code>Virtual DOM</code> =&gt; 真实<code>DOM</code>**的模型搭建成功,这也是数据变化、比较、更新的基础。</p>\n<h2 id="84-diff%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">8.4 diff算法实现<a class="anchor" href="#84-diff%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">§</a></h2>\n<p>更新组件的过程首先是响应式数据发生了变化,数据频繁的修改如果直接渲染到真实<code>DOM</code>上会引起整个<code>DOM</code>树的重绘和重排，频繁的重绘和重排是极其消耗性能的。如何优化这一渲染过程，<code>Vue</code>源码中给出了两个具体的思路，其中一个是在介绍响应式系统时提到的将多次修改推到一个队列中，在下一个<code>tick</code>去执行视图更新，另一个就是接下来要着重介绍的<code>diff</code>算法，将需要修改的数据进行比较，并只渲染必要的<code>DOM</code>。</p>\n<p>数据的改变最终会导致节点的改变，所以<code>diff</code>算法的核心在于在尽可能小变动的前提下找到需要更新的节点，直接调用原生相关<code>DOM</code>方法修改视图。不管是真实<code>DOM</code>还是前面创建的<code>Virtual DOM</code>,都可以理解为一颗<code>DOM</code>树，<strong>算法比较节点不同时，只会进行同层节点的比较，不会跨层进行比较，这也大大减少了算法复杂度。</strong></p>\n<h3 id="841-diffvnode">8.4.1 diffVnode<a class="anchor" href="#841-diffvnode">§</a></h3>\n<p>在之前的基础上，我们实现一个思路，1秒之后数据发生改变。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// index.html</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'span\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">1</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'strong\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">3</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">4</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n  <span class="token comment">// newVnode 表示改变后新的Vnode树</span>\n  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// diffVnode会比较新旧Vnode树，并完成视图更新</span>\n  vn<span class="token punctuation">.</span><span class="token method function property-access">diffVnode</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">,</span> preVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<p><code>diffVnode</code>的逻辑，会对比新旧节点的不同，并完成视图渲染更新</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  ···\n  <span class="token function">diffVnode</span><span class="token punctuation">(</span><span class="token parameter">nVnode<span class="token punctuation">,</span> oVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">,</span> oVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 直接更新根节点及所有子节点</span>\n      <span class="token keyword control-flow">return</span> <span class="token operator">**</span><span class="token operator">*</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">generateElm</span><span class="token punctuation">(</span>vonde<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">,</span> oVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="842-_samevnode">8.4.2 _sameVnode<a class="anchor" href="#842-_samevnode">§</a></h3>\n<p>新旧节点的对比是算法的第一步，如果新旧节点的根节点不是同一个节点，则直接替换节点。这遵从上面提到的原则，<strong>只进行同层节点的比较，节点不一致，直接用新节点及其子节点替换旧节点</strong>。为了理解方便，我们假定节点相同的判断是<code>tag</code>标签是否一致(实际源码要复杂)。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">_sameVnode</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> n<span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">===</span> o<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="843-generateelm">8.4.3 generateElm<a class="anchor" href="#843-generateelm">§</a></h3>\n<p><code>generateElm</code>的作用是跟踪每个节点实际的真实节点，方便在对比虚拟节点后实时更新真实<code>DOM</code>节点。虽然<code>Vue</code>源码中做法不同，但是这不是分析<code>diff</code>的重点。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">generateElm</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">traverseTree</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> parentEl</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> children <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        children<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n          c<span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">=</span> parentEl<span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token function">traverseTree</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">traverseTree</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>执行<code>generateElm</code>方法后，我们可以在旧节点的<code>Vnode</code>中跟踪到每个<code>Virtual DOM</code>的真实节点信息。</p>\n<h3 id="844-patchvnode">8.4.4 patchVnode<a class="anchor" href="#844-patchvnode">§</a></h3>\n<p><code>patchVnode</code>是新旧<code>Vnode</code>对比的核心方法，对比的逻辑如下。</p>\n<ol>\n<li>节点相同，且节点除了拥有文本节点外没有其他子节点。这种情况下直接替换文本内容。</li>\n<li>新节点没有子节点，旧节点有子节点，则删除旧节点所有子节点。</li>\n<li>旧节点没有子节点，新节点有子节点，则用新的所有子节点去更新旧节点。</li>\n<li>新旧都存在子节点。则对比子节点内容做操作。</li>\n</ol>\n<p>代码逻辑如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">nVnode<span class="token punctuation">,</span> oVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    \n    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">&amp;&amp;</span> nVnode<span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">!==</span> oVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 当前真实dom元素</span>\n      <span class="token keyword">let</span> ele <span class="token operator">=</span> oVnode<span class="token punctuation">.</span><span class="token property-access">elm</span>\n      <span class="token comment">// 子节点为文本节点</span>\n      ele<span class="token punctuation">.</span><span class="token property-access">textContent</span> <span class="token operator">=</span> nVnode<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oVnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> newCh <span class="token operator">=</span> nVnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token comment">// 新旧节点都存在。对比子节点</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">updateChildren</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> oldCh<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新节点没有子节点</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 老节点没有子节点</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>上述例子在<code>patchVnode</code>过程中，新旧子节点都存在，所以会走<code>updateChildren</code>分支。</p>\n<h3 id="845-updatechildren">8.4.5 updateChildren<a class="anchor" href="#845-updatechildren">§</a></h3>\n<p>子节点的对比，我们通过文字和画图的形式分析，通过图解的形式可以很清晰看到<code>diff</code>算法的巧妙之处。</p>\n<p>大致逻辑是：</p>\n<ol>\n<li>旧节点的起始位置为<code>oldStartIndex</code>,截至位置为<code>oldEndIndex</code>,新节点的起始位置为<code>newStartIndex</code>,截至位置为<code>newEndIndex</code>。</li>\n<li>新旧<code>children</code>的起始位置的元素两两对比，顺序是<code>newStartVnode, oldStartVnode</code>; <code>newEndVnode, oldEndVnode</code>;<code>newEndVnode, oldStartVnode</code>;<code>newStartIndex, oldEndIndex</code></li>\n<li><code>newStartVnode, oldStartVnode</code>节点相同，执行一次<code>patchVnode</code>过程，也就是递归对比相应子节点，并替换节点的过程。<code>oldStartIndex，newStartIndex</code>都像右移动一位。</li>\n<li><code>newEndVnode, oldEndVnode</code>节点相同，执行一次<code>patchVnode</code>过程，递归对比相应子节点，并替换节点。<code>oldEndIndex， newEndIndex</code>都像左移动一位。</li>\n<li><code>newEndVnode, oldStartVnode</code>节点相同，执行一次<code>patchVnode</code>过程，并将旧的<code>oldStartVnode</code>移动到尾部,<code>oldStartIndex</code>右移一味，<code>newEndIndex</code>左移一位。</li>\n<li><code>newStartIndex, oldEndIndex</code>节点相同，执行一次<code>patchVnode</code>过程，并将旧的<code>oldEndVnode</code>移动到头部,<code>oldEndIndex</code>左移一味，<code>newStartIndex</code>右移一位。</li>\n<li>四种组合都不相同，则会搜索旧节点所有子节点，找到将这个旧节点和<code>newStartVnode</code>执行<code>patchVnode</code>过程。</li>\n<li>不断对比的过程使得<code>oldStartIndex</code>不断逼近<code>oldEndIndex</code>，<code>newStartIndex</code>不断逼近<code>newEndIndex</code>。当<code>oldEndIndex &lt;= oldStartIndex</code>说明旧节点已经遍历完了，此时只要批量增加新节点即可。当<code>newEndIndex &lt;= newStartIndex</code>说明旧节点还有剩下，此时只要批量删除旧节点即可。</li>\n</ol>\n<p>结合前面的例子：</p>\n<p>第一步：</p>\n<p><img src="./img/8.3.png" alt=""></p>\n<p>第二步：</p>\n<p><img src="./img/8.4.png" alt=""></p>\n<p>第三步：</p>\n<p><img src="./img/8.5.png" alt=""></p>\n<p>第三步：</p>\n<p><img src="./img/8.6.png" alt=""></p>\n<p>第四步：</p>\n<p><img src="./img/8.7.png" alt=""></p>\n<p>根据这些步骤，代码实现如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> oldCh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 新children开始标志</span>\n    <span class="token keyword">let</span> newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 旧children开始标志</span>\n    <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 新children结束标志</span>\n    <span class="token keyword">let</span> newEndIndex <span class="token operator">=</span> newCh<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token comment">// 旧children结束标志</span>\n    <span class="token keyword">let</span> oldEndIndex <span class="token operator">=</span> oldCh<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldKeyToId<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> idxInOld<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 遍历结束条件</span>\n    <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span>newStartIndex <span class="token operator">&lt;=</span> newEndIndex <span class="token operator">&amp;&amp;</span> oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新children开始节点和旧开始节点相同</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newEndVnode<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新childre结束节点和旧结束节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>\n        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newEndVnode<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新childre结束节点和旧开始节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>\n        <span class="token comment">// 旧的oldStartVnode移动到尾部</span>\n        el<span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新children开始节点和旧结束节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        el<span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 都不符合的处理，查找新节点中与对比旧节点相同的vnode</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 新节点比旧节点多，批量增加节点</span>\n    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>oldEndIndex <span class="token operator">&lt;=</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 批量增加节点</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createElm</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> newCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_setAttrs</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> testEle <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>testEle<span class="token punctuation">)</span>\n    el<span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> el<span class="token punctuation">.</span><span class="token property-access">nextSibling</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 查找匹配值</span>\n  <span class="token function">findIdxInOld</span><span class="token punctuation">(</span><span class="token parameter">newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> c <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> i <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="85-diff%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96">8.5 diff算法优化<a class="anchor" href="#85-diff%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96">§</a></h2>\n<p>前面有个分支，当四种比较节点都找不到匹配时，会调用<code>findIdxInOld</code>找到旧节点中和新的比较节点一致的节点。节点搜索在数量级较大时是缓慢的。查看<code>Vue</code>的源码，发现它在这一个环节做了优化，也就是我们经常在编写列表时被要求加入的唯一属性<strong>key</strong>，有了这个唯一的标志位，我们可以对旧节点建立简单的字典查询，只要有<code>key</code>值便可以方便的搜索到符合要求的旧节点。修改代码：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 都不符合的处理，查找新节点中与对比旧节点相同的vnode</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldKeyToId<span class="token punctuation">)</span> oldKeyToId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createKeyMap</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIndex<span class="token punctuation">,</span> oldEndIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      idxInOld <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span> <span class="token operator">?</span> oldKeyToId<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIndex<span class="token punctuation">,</span> oldEndIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 后续操作</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 建立字典</span>\n  <span class="token function">createKeyMap</span><span class="token punctuation">(</span><span class="token parameter">oldCh<span class="token punctuation">,</span> start<span class="token punctuation">,</span> old</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> old<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span> map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword control-flow">return</span> map<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n\n</code></pre>\n<h2 id="86-%E9%97%AE%E9%A2%98%E6%80%9D%E8%80%83">8.6 问题思考<a class="anchor" href="#86-%E9%97%AE%E9%A2%98%E6%80%9D%E8%80%83">§</a></h2>\n<p>最后我们思考一个问题，<code>Virtual DOM</code> 的重绘性能真的比单纯的<code>innerHTML</code>要好吗，其实并不是这样的，作者的<a href="https://www.zhihu.com/question/31809713/answer/53544875">解释</a></p>\n<blockquote>\n<ul>\n<li><code>innerHTML:  render html string O(template size) +</code> 重新创建所有 <code>DOM</code> 元素 <code>O(DOM size)</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li><code>Virtual DOM: render Virtual DOM + diff O(template size) +</code> 必要的 <code>DOM</code> 更新 <code>O(DOM change)</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li><code>Virtual DOM render + diff</code> 显然比渲染 html 字符串要慢，但是！它依然是纯 js 层面的计算，比起后面的 <code>DOM</code> 操作来说，依然便宜了太多。可以看到，<code>innerHTML</code> 的总计算量不管是 <code>js</code> 计算还是 <code>DOM </code>操作都是和整个界面的大小相关，但<code>Virtual DOM</code> 的计算量里面，只有 <code>js</code> 计算和界面大小相关，DOM 操作是和数据的变动量相关的。</li>\n</ul>\n</blockquote>'
        } }),
    'head': React.createElement(React.Fragment, null,
        React.createElement("link", { href: "/In-depth-analysis-of-Vue/src/assets/favicon.ico", rel: "icon" })),
    'script': React.createElement(React.Fragment, null,
        React.createElement("script", { src: "https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js" }),
        React.createElement("script", { src: "https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js" }),
        React.createElement("script", { src: "/In-depth-analysis-of-Vue/index.js", type: "module" })),
    'footer': React.createElement("footer", null,
        "Powered by\u00A0",
        React.createElement("a", { href: "https://github.com/xcatliu/pagic", target: "_blank" }, "Pagic")),
    'contentTitle': undefined,
    'contentBody': React.createElement("article", { dangerouslySetInnerHTML: {
            __html: '<blockquote>\n<p>这一节，依然是<strong>深入剖析Vue源码系列</strong>，上几节内容介绍了<code>Virtual DOM</code>是Vue在渲染机制上做的优化，而渲染的核心在于数据变化时，如何高效的更新节点，这就是diff算法。由于源码中关于<code>diff</code>算法部分流程复杂，直接剖析每个流程不易于理解，所以这一节我们换一个思路，参考源码来手动实现一个简易版的<code>diff</code>算法。</p>\n</blockquote>\n<p>之前讲到<code>Vue</code>在渲染机制的优化上，引入了<code>Virtual DOM</code>的概念，利用<code>Virtual DOM</code>描述一个真实的<code>DOM</code>,本质上是在<code>JS</code>和真实<code>DOM</code>之间架起了一层缓冲层。当我们通过大量的<code>JS</code>运算,并将最终结果反应到浏览器进行渲染时，<code>Virtual DOM</code>可以将多个改动合并成一个批量的操作，从而减少 <code>dom</code> 重排的次数，进而缩短了生成渲染树和绘制节点所花的时间，达到渲染优化的目的。之前的章节，我们简单的介绍了<code>Vue</code>中<code>Vnode</code>的概念，以及创建<code>Vnode</code>到<code>渲染Vnode</code>再到真实<code>DOM</code>的过程。如果有忘记流程的，可以参考前面的章节分析。</p>\n<p>**从<code>render</code>函数到创建虚拟<code>DOM</code>,再到渲染真实节点，这一过程是完整的，也是容易理解的。然而引入虚拟<code>DOM</code>的核心不在这里，而在于当数据发生变化时，如何最优化数据变动到视图更新的过程。这一个过程才是<code>Vnode</code>更新视图的核心，也就是常说的<code>diff</code>算法。**下面跟着我来实现一个简易版的<code>diff</code>算法</p>\n<h2 id="81-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E7%B1%BB">8.1 创建基础类<a class="anchor" href="#81-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E7%B1%BB">§</a></h2>\n<p>代码编写过程会遇到很多基本类型的判断，第一步需要先将这些方法封装。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Util</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token comment">// 检测基础类型</span>\n  <span class="token function">_isPrimitive</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'number\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'symbol\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'boolean\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 判断值不为空</span>\n  <span class="token function">_isDef</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> v <span class="token operator">!==</span> <span class="token keyword nil">undefined</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">!==</span> <span class="token keyword null nil">null</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 工具类的使用</span>\n<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Util</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre>\n<h2 id="82-%E5%88%9B%E5%BB%BAvnode">8.2 创建Vnode<a class="anchor" href="#82-%E5%88%9B%E5%BB%BAvnode">§</a></h2>\n<p><code>Vnode</code>这个类在之前章节已经分析过源码，本质上是用一个对象去描述一个真实的<code>DOM</code>元素，简易版关注点在于元素的<code>tag</code>标签，元素的属性集合<code>data</code>,元素的子节点<code>children</code>,<code>text</code>为元素的文本节点,简单的描述类如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">=</span> tag<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">=</span> children<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">=</span> <span class="token string">\'\'</span>\n    <span class="token comment">// text属性用于标志Vnode节点没有其他子节点，只有纯文本</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isPrimitive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">:</span> <span class="token string">\'\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="83-%E6%A8%A1%E6%8B%9F%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B">8.3 模拟渲染过程<a class="anchor" href="#83-%E6%A8%A1%E6%8B%9F%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B">§</a></h2>\n<p>接下来需要创建另一个类模拟将<code>render</code>函数转换为<code>Vnode</code>,并将<code>Vnode</code>渲染为真实<code>DOM</code>的过程，我们将这个类定义为<code>Vn</code>,<code>Vn</code>具有两个基本的方法<code>createVnode, createElement</code>, 分别实现创建虚拟<code>Vnode</code>,和创建真实<code>DOM</code>的过程。</p>\n<h3 id="831-createvnode">8.3.1 createVnode<a class="anchor" href="#831-createvnode">§</a></h3>\n<p><code>createVnode</code>模拟<code>Vue</code>中<code>render</code>函数的实现思路，目的是将数据转换为虚拟的<code>Vnode</code>,先看具体的使用和定义。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// index.html</span>\n\n<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"diff.js"</span><span class="token operator">></span>\n<span class="token operator">&lt;</span>script<span class="token operator">></span>\n\n<span class="token comment">// 创建Vnode</span>\n\n<span class="token keyword">let</span> <span class="token function-variable function">createVnode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> _c <span class="token operator">=</span> vn<span class="token punctuation">.</span><span class="token property-access">createVnode</span><span class="token punctuation">;</span>\n  <span class="token keyword control-flow">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">\'test\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token arrow operator">=></span> <span class="token function">_c</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 元素内容结构</span>\n<span class="token keyword">let</span> arr <span class="token operator">=</span> \n  <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'span\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">3</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'strong\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">4</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>\n\n\n\n<span class="token comment">// diff.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token comment">// 创建虚拟Vnode</span>\n    <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  global<span class="token punctuation">.</span><span class="token property-access">vn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n</code></pre>\n<p>这是一个完整的<code>Vnode</code>对象，我们已经可以用这个对象来简单的描述一个<code>DOM</code>节点，而<code>createElement</code>就是将这个对象对应到真实节点的过程。最终我们希望的结果是这样的。</p>\n<p><strong>Vnode对象</strong></p>\n<p><img src="./img/8.1.png" alt=""></p>\n<p><strong>渲染结果</strong></p>\n<p><img src="./img/8.2.png" alt=""></p>\n<h3 id="832-createelement">8.3.2 createElement<a class="anchor" href="#832-createelement">§</a></h3>\n<p>渲染真实<code>DOM</code>的过程就是遍历<code>Vnode</code>对象，递归创建真实节点的过程，这个不是本文的重点，所以我们可以粗糙的实现。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> el <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token operator">!</span>el <span class="token operator">||</span> <span class="token operator">!</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">\'无法找到根节点\'</span><span class="token punctuation">)</span>\n      <span class="token keyword">let</span> <span class="token function-variable function">_createElement</span> <span class="token operator">=</span> <span class="token parameter">vnode</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 添加属性</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setAttr</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 简单的文本节点，只要创建文本节点即可</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isPrimitive</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> testEle <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>testEle<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 复杂的子节点需要遍历子节点递归创建节点。</span>\n          children<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">_createElement</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword control-flow">return</span> ele\n      <span class="token punctuation">}</span>\n      <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">_createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="833-setattr">8.3.3 setAttr<a class="anchor" href="#833-setattr">§</a></h3>\n<p><code>setAttr</code>是为节点设置属性的方法，利用<code>DOM</code>原生的<code>setAttribute</code>为每个节点设置属性值。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">setAttr</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>\n    <span class="token keyword">const</span> attrs <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">attrs</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attrs<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>\n    <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n      el<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>至此一个简单的 **数据 -&gt; <code>Virtual DOM</code> =&gt; 真实<code>DOM</code>**的模型搭建成功,这也是数据变化、比较、更新的基础。</p>\n<h2 id="84-diff%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">8.4 diff算法实现<a class="anchor" href="#84-diff%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0">§</a></h2>\n<p>更新组件的过程首先是响应式数据发生了变化,数据频繁的修改如果直接渲染到真实<code>DOM</code>上会引起整个<code>DOM</code>树的重绘和重排，频繁的重绘和重排是极其消耗性能的。如何优化这一渲染过程，<code>Vue</code>源码中给出了两个具体的思路，其中一个是在介绍响应式系统时提到的将多次修改推到一个队列中，在下一个<code>tick</code>去执行视图更新，另一个就是接下来要着重介绍的<code>diff</code>算法，将需要修改的数据进行比较，并只渲染必要的<code>DOM</code>。</p>\n<p>数据的改变最终会导致节点的改变，所以<code>diff</code>算法的核心在于在尽可能小变动的前提下找到需要更新的节点，直接调用原生相关<code>DOM</code>方法修改视图。不管是真实<code>DOM</code>还是前面创建的<code>Virtual DOM</code>,都可以理解为一颗<code>DOM</code>树，<strong>算法比较节点不同时，只会进行同层节点的比较，不会跨层进行比较，这也大大减少了算法复杂度。</strong></p>\n<h3 id="841-diffvnode">8.4.1 diffVnode<a class="anchor" href="#841-diffvnode">§</a></h3>\n<p>在之前的基础上，我们实现一个思路，1秒之后数据发生改变。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// index.html</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'span\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">1</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'strong\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">3</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>\n    tag<span class="token operator">:</span> <span class="token string">\'i\'</span><span class="token punctuation">,</span>\n    text<span class="token operator">:</span> <span class="token number">4</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n  <span class="token comment">// newVnode 表示改变后新的Vnode树</span>\n  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// diffVnode会比较新旧Vnode树，并完成视图更新</span>\n  vn<span class="token punctuation">.</span><span class="token method function property-access">diffVnode</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">,</span> preVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<p><code>diffVnode</code>的逻辑，会对比新旧节点的不同，并完成视图渲染更新</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  ···\n  <span class="token function">diffVnode</span><span class="token punctuation">(</span><span class="token parameter">nVnode<span class="token punctuation">,</span> oVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">,</span> oVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 直接更新根节点及所有子节点</span>\n      <span class="token keyword control-flow">return</span> <span class="token operator">**</span><span class="token operator">*</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">generateElm</span><span class="token punctuation">(</span>vonde<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">,</span> oVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="842-_samevnode">8.4.2 _sameVnode<a class="anchor" href="#842-_samevnode">§</a></h3>\n<p>新旧节点的对比是算法的第一步，如果新旧节点的根节点不是同一个节点，则直接替换节点。这遵从上面提到的原则，<strong>只进行同层节点的比较，节点不一致，直接用新节点及其子节点替换旧节点</strong>。为了理解方便，我们假定节点相同的判断是<code>tag</code>标签是否一致(实际源码要复杂)。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">_sameVnode</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span> n<span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">===</span> o<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h3 id="843-generateelm">8.4.3 generateElm<a class="anchor" href="#843-generateelm">§</a></h3>\n<p><code>generateElm</code>的作用是跟踪每个节点实际的真实节点，方便在对比虚拟节点后实时更新真实<code>DOM</code>节点。虽然<code>Vue</code>源码中做法不同，但是这不是分析<code>diff</code>的重点。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">generateElm</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">traverseTree</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> parentEl</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> children <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        children<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>\n          c<span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">=</span> parentEl<span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token function">traverseTree</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">traverseTree</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>执行<code>generateElm</code>方法后，我们可以在旧节点的<code>Vnode</code>中跟踪到每个<code>Virtual DOM</code>的真实节点信息。</p>\n<h3 id="844-patchvnode">8.4.4 patchVnode<a class="anchor" href="#844-patchvnode">§</a></h3>\n<p><code>patchVnode</code>是新旧<code>Vnode</code>对比的核心方法，对比的逻辑如下。</p>\n<ol>\n<li>节点相同，且节点除了拥有文本节点外没有其他子节点。这种情况下直接替换文本内容。</li>\n<li>新节点没有子节点，旧节点有子节点，则删除旧节点所有子节点。</li>\n<li>旧节点没有子节点，新节点有子节点，则用新的所有子节点去更新旧节点。</li>\n<li>新旧都存在子节点。则对比子节点内容做操作。</li>\n</ol>\n<p>代码逻辑如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">nVnode<span class="token punctuation">,</span> oVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    \n    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>nVnode<span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">&amp;&amp;</span> nVnode<span class="token punctuation">.</span><span class="token property-access">text</span> <span class="token operator">!==</span> oVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 当前真实dom元素</span>\n      <span class="token keyword">let</span> ele <span class="token operator">=</span> oVnode<span class="token punctuation">.</span><span class="token property-access">elm</span>\n      <span class="token comment">// 子节点为文本节点</span>\n      ele<span class="token punctuation">.</span><span class="token property-access">textContent</span> <span class="token operator">=</span> nVnode<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oVnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> newCh <span class="token operator">=</span> nVnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span>\n      <span class="token comment">// 新旧节点都存在。对比子节点</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">updateChildren</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> oldCh<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新节点没有子节点</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 老节点没有子节点</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>上述例子在<code>patchVnode</code>过程中，新旧子节点都存在，所以会走<code>updateChildren</code>分支。</p>\n<h3 id="845-updatechildren">8.4.5 updateChildren<a class="anchor" href="#845-updatechildren">§</a></h3>\n<p>子节点的对比，我们通过文字和画图的形式分析，通过图解的形式可以很清晰看到<code>diff</code>算法的巧妙之处。</p>\n<p>大致逻辑是：</p>\n<ol>\n<li>旧节点的起始位置为<code>oldStartIndex</code>,截至位置为<code>oldEndIndex</code>,新节点的起始位置为<code>newStartIndex</code>,截至位置为<code>newEndIndex</code>。</li>\n<li>新旧<code>children</code>的起始位置的元素两两对比，顺序是<code>newStartVnode, oldStartVnode</code>; <code>newEndVnode, oldEndVnode</code>;<code>newEndVnode, oldStartVnode</code>;<code>newStartIndex, oldEndIndex</code></li>\n<li><code>newStartVnode, oldStartVnode</code>节点相同，执行一次<code>patchVnode</code>过程，也就是递归对比相应子节点，并替换节点的过程。<code>oldStartIndex，newStartIndex</code>都像右移动一位。</li>\n<li><code>newEndVnode, oldEndVnode</code>节点相同，执行一次<code>patchVnode</code>过程，递归对比相应子节点，并替换节点。<code>oldEndIndex， newEndIndex</code>都像左移动一位。</li>\n<li><code>newEndVnode, oldStartVnode</code>节点相同，执行一次<code>patchVnode</code>过程，并将旧的<code>oldStartVnode</code>移动到尾部,<code>oldStartIndex</code>右移一味，<code>newEndIndex</code>左移一位。</li>\n<li><code>newStartIndex, oldEndIndex</code>节点相同，执行一次<code>patchVnode</code>过程，并将旧的<code>oldEndVnode</code>移动到头部,<code>oldEndIndex</code>左移一味，<code>newStartIndex</code>右移一位。</li>\n<li>四种组合都不相同，则会搜索旧节点所有子节点，找到将这个旧节点和<code>newStartVnode</code>执行<code>patchVnode</code>过程。</li>\n<li>不断对比的过程使得<code>oldStartIndex</code>不断逼近<code>oldEndIndex</code>，<code>newStartIndex</code>不断逼近<code>newEndIndex</code>。当<code>oldEndIndex &lt;= oldStartIndex</code>说明旧节点已经遍历完了，此时只要批量增加新节点即可。当<code>newEndIndex &lt;= newStartIndex</code>说明旧节点还有剩下，此时只要批量删除旧节点即可。</li>\n</ol>\n<p>结合前面的例子：</p>\n<p>第一步：</p>\n<p><img src="./img/8.3.png" alt=""></p>\n<p>第二步：</p>\n<p><img src="./img/8.4.png" alt=""></p>\n<p>第三步：</p>\n<p><img src="./img/8.5.png" alt=""></p>\n<p>第三步：</p>\n<p><img src="./img/8.6.png" alt=""></p>\n<p>第四步：</p>\n<p><img src="./img/8.7.png" alt=""></p>\n<p>根据这些步骤，代码实现如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> oldCh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 新children开始标志</span>\n    <span class="token keyword">let</span> newStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 旧children开始标志</span>\n    <span class="token keyword">let</span> oldStartIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 新children结束标志</span>\n    <span class="token keyword">let</span> newEndIndex <span class="token operator">=</span> newCh<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token comment">// 旧children结束标志</span>\n    <span class="token keyword">let</span> oldEndIndex <span class="token operator">=</span> oldCh<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldKeyToId<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> idxInOld<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 遍历结束条件</span>\n    <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span>newStartIndex <span class="token operator">&lt;=</span> newEndIndex <span class="token operator">&amp;&amp;</span> oldStartIndex <span class="token operator">&lt;=</span> oldEndIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新children开始节点和旧开始节点相同</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newEndVnode<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新childre结束节点和旧结束节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>\n        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newEndVnode<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 新childre结束节点和旧开始节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>\n        <span class="token comment">// 旧的oldStartVnode移动到尾部</span>\n        el<span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新children开始节点和旧结束节点相同</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">patchVnode</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        el<span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 都不符合的处理，查找新节点中与对比旧节点相同的vnode</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 新节点比旧节点多，批量增加节点</span>\n    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>oldEndIndex <span class="token operator">&lt;=</span> oldStartIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 批量增加节点</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createElm</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>oldEndIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> newCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_setAttrs</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> testEle <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ele<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>testEle<span class="token punctuation">)</span>\n    el<span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> el<span class="token punctuation">.</span><span class="token property-access">nextSibling</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 查找匹配值</span>\n  <span class="token function">findIdxInOld</span><span class="token punctuation">(</span><span class="token parameter">newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> c <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token method function property-access">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">sameVnode</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> i <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="85-diff%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96">8.5 diff算法优化<a class="anchor" href="#85-diff%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96">§</a></h2>\n<p>前面有个分支，当四种比较节点都找不到匹配时，会调用<code>findIdxInOld</code>找到旧节点中和新的比较节点一致的节点。节点搜索在数量级较大时是缓慢的。查看<code>Vue</code>的源码，发现它在这一个环节做了优化，也就是我们经常在编写列表时被要求加入的唯一属性<strong>key</strong>，有了这个唯一的标志位，我们可以对旧节点建立简单的字典查询，只要有<code>key</code>值便可以方便的搜索到符合要求的旧节点。修改代码：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Vn</span> <span class="token punctuation">{</span>\n  <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 都不符合的处理，查找新节点中与对比旧节点相同的vnode</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldKeyToId<span class="token punctuation">)</span> oldKeyToId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createKeyMap</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIndex<span class="token punctuation">,</span> oldEndIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      idxInOld <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token method function property-access">_isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span> <span class="token operator">?</span> oldKeyToId<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIndex<span class="token punctuation">,</span> oldEndIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 后续操作</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 建立字典</span>\n  <span class="token function">createKeyMap</span><span class="token punctuation">(</span><span class="token parameter">oldCh<span class="token punctuation">,</span> start<span class="token punctuation">,</span> old</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> old<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span> map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword control-flow">return</span> map<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n\n</code></pre>\n<h2 id="86-%E9%97%AE%E9%A2%98%E6%80%9D%E8%80%83">8.6 问题思考<a class="anchor" href="#86-%E9%97%AE%E9%A2%98%E6%80%9D%E8%80%83">§</a></h2>\n<p>最后我们思考一个问题，<code>Virtual DOM</code> 的重绘性能真的比单纯的<code>innerHTML</code>要好吗，其实并不是这样的，作者的<a href="https://www.zhihu.com/question/31809713/answer/53544875">解释</a></p>\n<blockquote>\n<ul>\n<li><code>innerHTML:  render html string O(template size) +</code> 重新创建所有 <code>DOM</code> 元素 <code>O(DOM size)</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li><code>Virtual DOM: render Virtual DOM + diff O(template size) +</code> 必要的 <code>DOM</code> 更新 <code>O(DOM change)</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li><code>Virtual DOM render + diff</code> 显然比渲染 html 字符串要慢，但是！它依然是纯 js 层面的计算，比起后面的 <code>DOM</code> 操作来说，依然便宜了太多。可以看到，<code>innerHTML</code> 的总计算量不管是 <code>js</code> 计算还是 <code>DOM </code>操作都是和整个界面的大小相关，但<code>Virtual DOM</code> 的计算量里面，只有 <code>js</code> 计算和界面大小相关，DOM 操作是和数据的变动量相关的。</li>\n</ul>\n</blockquote>'
        } }),
    'toc': React.createElement("nav", { key: "0", className: "toc" },
        React.createElement("ol", null,
            React.createElement("li", null,
                React.createElement("a", { href: "#81-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E7%B1%BB" }, "8.1 \u521B\u5EFA\u57FA\u7840\u7C7B")),
            React.createElement("li", null,
                React.createElement("a", { href: "#82-%E5%88%9B%E5%BB%BAvnode" }, "8.2 \u521B\u5EFAVnode")),
            React.createElement("li", null,
                React.createElement("a", { href: "#83-%E6%A8%A1%E6%8B%9F%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B" }, "8.3 \u6A21\u62DF\u6E32\u67D3\u8FC7\u7A0B"),
                React.createElement("ol", null,
                    React.createElement("li", null,
                        React.createElement("a", { href: "#831-createvnode" }, "8.3.1 createVnode")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#832-createelement" }, "8.3.2 createElement")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#833-setattr" }, "8.3.3 setAttr")))),
            React.createElement("li", null,
                React.createElement("a", { href: "#84-diff%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0" }, "8.4 diff\u7B97\u6CD5\u5B9E\u73B0"),
                React.createElement("ol", null,
                    React.createElement("li", null,
                        React.createElement("a", { href: "#841-diffvnode" }, "8.4.1 diffVnode")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#842-_samevnode" }, "8.4.2 _sameVnode")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#843-generateelm" }, "8.4.3 generateElm")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#844-patchvnode" }, "8.4.4 patchVnode")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#845-updatechildren" }, "8.4.5 updateChildren")))),
            React.createElement("li", null,
                React.createElement("a", { href: "#85-diff%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96" }, "8.5 diff\u7B97\u6CD5\u4F18\u5316")),
            React.createElement("li", null,
                React.createElement("a", { href: "#86-%E9%97%AE%E9%A2%98%E6%80%9D%E8%80%83" }, "8.6 \u95EE\u9898\u601D\u8003")))),
    'author': "wyp",
    'contributors': [
        "wyp"
    ],
    'date': "2019-10-29T06:12:00.000Z",
    'updated': "2019-10-30T09:03:02.000Z",
    'excerpt': "之前讲到Vue在渲染机制的优化上，引入了Virtual DOM的概念，利用Virtual DOM描述一个真实的DOM,本质上是在JS和真实DOM之间架起了一层缓冲层。当我们通过大量的JS运算,并将最终结果反应到浏览器进行渲染时，Virtual DOM可以将多...",
    'cover': "./img/8.1.png",
    'sidebar': [
        {
            "text": "1.丰富的选项合并策略",
            "link": "/In-depth-analysis-of-Vue/src/1.丰富的选项合并策略.md"
        },
        {
            "text": "2.基础的数据代理检测",
            "link": "/In-depth-analysis-of-Vue/src/2.基础的数据代理检测.md"
        },
        {
            "text": "3.实例挂载流程和模板编译",
            "link": "/In-depth-analysis-of-Vue/src/3.实例挂载流程和模板编译.md"
        },
        {
            "text": "4.完整渲染流程",
            "link": "/In-depth-analysis-of-Vue/src/4.完整渲染流程.md"
        },
        {
            "text": "5.组件基础剖析",
            "link": "/In-depth-analysis-of-Vue/src/5.组件基础剖析.md"
        },
        {
            "text": "6.组件高级用法",
            "link": "/In-depth-analysis-of-Vue/src/6.组件高级用法.md"
        },
        {
            "text": "7.深入响应式系统构建-上",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-上.md"
        },
        {
            "text": "7.深入响应式系统构建-中",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-中.md"
        },
        {
            "text": "7.深入响应式系统构建-下",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-下.md"
        },
        {
            "text": "8.来，跟我一起实现diff算法",
            "link": "/In-depth-analysis-of-Vue/src/8.来，跟我一起实现diff算法.md"
        },
        {
            "text": "9.揭秘Vue的事件机制",
            "link": "/In-depth-analysis-of-Vue/src/9.揭秘Vue的事件机制.md"
        },
        {
            "text": "10.vue插槽，你想了解的都在这里",
            "link": "/In-depth-analysis-of-Vue/src/10.vue插槽，你想了解的都在这里.md"
        },
        {
            "text": "11.你真的了解v-model的语法糖了吗",
            "link": "/In-depth-analysis-of-Vue/src/11.你真的了解v-model的语法糖了吗.md"
        },
        {
            "text": "12.动态组件的深入分析",
            "link": "/In-depth-analysis-of-Vue/src/12.动态组件的深入分析.md"
        },
        {
            "text": "13.彻底搞懂Vue中keep-alive的魔法-上",
            "link": "/In-depth-analysis-of-Vue/src/13.彻底搞懂Vue中keep-alive的魔法-上.md"
        },
        {
            "text": "13.彻底搞懂Vue中keep-alive的魔法-下",
            "link": "/In-depth-analysis-of-Vue/src/13.彻底搞懂Vue中keep-alive的魔法-下.md"
        }
    ]
};
