import projectConfig from '/In-depth-analysis-of-Vue/pagic.config.js';
export default {
    'prev': undefined,
    'next': undefined,
    config: { "root": "/", ...projectConfig, branch: 'pagic' },
    'pagePath': "src/彻底搞懂Vue中keep-alive的魔法-下.md",
    'layoutPath': "_layout.tsx",
    'outputPath': "src/彻底搞懂Vue中keep-alive的魔法-下.html",
    'title': undefined,
    'content': React.createElement("article", { dangerouslySetInnerHTML: {
            __html: '<blockquote>\n<p>上一节，我们对<code>keep-alive</code>组件的初始渲染流程以及组件的配置信息进行了源码分析。初始渲染流程最关键的一步是对渲染的组件<code>Vnode</code>进行缓存，其中也包括了组件的真实节点存储。有了第一次的缓存，当再次渲染组件时，<code>keep-alive</code>又拥有哪些魔法呢？接下来我们将彻底揭开这一层面纱。</p>\n</blockquote>\n<h2 id="135-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">13.5 准备工作<a class="anchor" href="#135-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">§</a></h2>\n<p>上一节对<code>keep-alive</code>组件的分析，是从我画的一个流程图开始的。如果不想回过头看上一节的内容，可以参考以下的简单总结。</p>\n<ol>\n<li><code>keep-alive</code>是源码内部定义的组件选项配置，它会先注册为全局组件供开发者全局使用，其中<code>render</code>函数定义了它的渲染过程</li>\n<li>和普通组件一致，当父在创建真实节点的过程中，遇到<code>keep-alive</code>的组件会进行组件的初始化和实例化。</li>\n<li>实例化会执行挂载<code>$mount</code>的过程，这一步会执行<code>keep-alive</code>选项中的<code>render</code>函数。</li>\n<li><code>render</code>函数在初始渲染时，会将渲染的子<code>Vnode</code>进行缓存。同时<strong>对应的子真实节点也会被缓存起来</strong>。</li>\n</ol>\n<p>那么，当再次需要渲染到已经被渲染过的组件时，<code>keep-alive</code>的处理又有什么不同呢？</p>\n<h3 id="1351-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">13.5.1 基础使用<a class="anchor" href="#1351-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">§</a></h3>\n<p>为了文章的完整性，我依旧把基础的使用展示出来，其中加入了生命周期的使用，方便后续对<code>keep-alive</code>生命周期的分析。</p>\n<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changeTabs(<span class="token punctuation">\'</span>child1<span class="token punctuation">\'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>child1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changeTabs(<span class="token punctuation">\'</span>child2<span class="token punctuation">\'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>child2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">></span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chooseTabs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n</code></pre>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token punctuation">{</span>\n    template<span class="token operator">:</span> <span class="token string">\'&lt;div>&lt;button @click="add">add&lt;/button>&lt;p>{{num}}&lt;/p>&lt;/div>\'</span><span class="token punctuation">,</span>\n    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>\n            num<span class="token operator">:</span> <span class="token number">1</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    methods<span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token operator">++</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 mounted\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 activated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 deactivated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 destoryed\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> child2 <span class="token operator">=</span> <span class="token punctuation">{</span>\n    template<span class="token operator">:</span> <span class="token string">\'&lt;div>child2&lt;/div>\'</span><span class="token punctuation">,</span>\n    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 mounted\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 activated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 deactivated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 destoryed\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    el<span class="token operator">:</span> <span class="token string">\'#app\'</span><span class="token punctuation">,</span>\n    components<span class="token operator">:</span> <span class="token punctuation">{</span>\n        child1<span class="token punctuation">,</span>\n        child2<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>\n            chooseTabs<span class="token operator">:</span> <span class="token string">\'child1\'</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    methods<span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">changeTabs</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">chooseTabs</span> <span class="token operator">=</span> tab<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<h3 id="1352-%E6%B5%81%E7%A8%8B%E5%9B%BE">13.5.2 流程图<a class="anchor" href="#1352-%E6%B5%81%E7%A8%8B%E5%9B%BE">§</a></h3>\n<p>和首次渲染的分析一致，再次渲染的过程我依旧画了一个简单的流程图。</p>\n<p><img src="./img/13.3.png" alt=""></p>\n<h2 id="136-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">13.6 流程分析<a class="anchor" href="#136-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">§</a></h2>\n<h3 id="1361-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6">13.6.1 重新渲染组件<a class="anchor" href="#1361-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6">§</a></h3>\n<p>再次渲染的流程从数据改变说起，在这个例子中，动态组件中<code>chooseTabs</code>数据的变化会引起依赖派发更新的过程(这个系列有三篇文章详细介绍了vue响应式系统的底层实现，感兴趣的同学可以借鉴)。简单来说，<code>chooseTabs</code>这个数据在初始化阶段会收集使用到该数据的相关依赖。当数据发生改变时，收集过的依赖会进行派发更新操作。</p>\n<p>其中，父组件中负责实例挂载的过程作为依赖会被执行，即执行父组件的<code>vm._update(vm._render(), hydrating);</code>。<code>_render</code>和<code>_update</code>分别代表两个过程，其中<code>_render</code>函数会根据数据的变化为组件生成新的<code>Vnode</code>节点，而<code>_update</code>最终会为新的<code>Vnode</code>生成真实的节点。而在生成真实节点的过程中，会利用<code>vitrual dom</code>的<code>diff</code>算法对前后<code>vnode</code>节点进行对比，使之尽可能少的更改真实节点，这一部分内容可以回顾<a href="https://juejin.im/post/5d3967a56fb9a07efc49cca1">深入剖析Vue源码 - 来，跟我一起实现diff算法!</a>，里面详细阐述了利用<code>diff</code>算法进行节点差异对比的思路。</p>\n<p><code>patch</code>是新旧<code>Vnode</code>节点对比的过程，而<code>patchVnode</code>是其中核心的步骤，我们忽略<code>patchVnode</code>其他的流程，关注到其中对子组件执行<code>prepatch</code>钩子的过程中。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">,</span>insertedVnodeQueue<span class="token punctuation">,</span>ownerArray<span class="token punctuation">,</span>index<span class="token punctuation">,</span>removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token comment">// 新vnode  执行prepatch钩子</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">prepatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    ···\n<span class="token punctuation">}</span>\n</code></pre>\n<p>执行<code>prepatch</code>钩子时会拿到新旧组件的实例并执行<code>updateChildComponent</code>函数。而<code>updateChildComponent</code>会对针对新的组件实例对旧实例进行状态的更新，包括<code>props,listeners</code>等，最终会<strong>调用<code>vue</code>提供的全局<code>vm.$forceUpdate()</code>方法进行实例的重新渲染。</strong></p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 之前分析的init钩子 </span>\n    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">prepatch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">prepatch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新组件实例</span>\n      <span class="token keyword">var</span> options <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentOptions</span><span class="token punctuation">;</span>\n      <span class="token comment">// 旧组件实例</span>\n      <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token function">updateChildComponent</span><span class="token punctuation">(</span>\n        child<span class="token punctuation">,</span>\n        options<span class="token punctuation">.</span><span class="token property-access">propsData</span><span class="token punctuation">,</span> <span class="token comment">// updated props</span>\n        options<span class="token punctuation">.</span><span class="token property-access">listeners</span><span class="token punctuation">,</span> <span class="token comment">// updated listeners</span>\n        vnode<span class="token punctuation">,</span> <span class="token comment">// new parent vnode</span>\n        options<span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token comment">// new children</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">updateChildComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 更新旧的状态，不分析这个过程</span>\n    ···\n    <span class="token comment">// 迫使实例重新渲染。</span>\n    vm<span class="token punctuation">.</span><span class="token method function property-access">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>先看看<code>$forceUpdate</code>做了什么操作。<code>$forceUpdate</code>是源码对外暴露的一个api，他们迫使<code>Vue</code>实例重新渲染，本质上是执行实例所收集的依赖，在例子中<code>watcher</code>对应的是<code>keep-alive</code>的<code>vm._update(vm._render(), hydrating);</code>过程。</p>\n<pre class="language-js"><code class="language-js"><span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      vm<span class="token punctuation">.</span><span class="token property-access">_watcher</span><span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre>\n<h3 id="1362-%E9%87%8D%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6">13.6.2 重用缓存组件<a class="anchor" href="#1362-%E9%87%8D%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6">§</a></h3>\n<p>由于<code>vm.$forceUpdate()</code>会强迫<code>keep-alive</code>组件进行重新渲染，因此<code>keep-alive</code>组件会再一次执行<code>render</code>过程。这一次由于第一次对<code>vnode</code>的缓存，<code>keep-alive</code>在实例的<code>cache</code>对象中找到了缓存的组件。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// keepalive组件选项</span>\n<span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token string">\'keep-alive\'</span><span class="token punctuation">,</span>\n    abstract<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 拿到keep-alive下插槽的值</span>\n      <span class="token keyword">var</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">$slots</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>\n      <span class="token comment">// 第一个vnode节点</span>\n      <span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 拿到第一个组件实例</span>\n      <span class="token keyword">var</span> componentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentOptions</span><span class="token punctuation">;</span>\n      <span class="token comment">// keep-alive的第一个子组件实例存在</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// check pattern</span>\n        <span class="token comment">//拿到第一个vnode节点的name</span>\n        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> include <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">include</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> exclude <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">exclude</span><span class="token punctuation">;</span>\n        <span class="token comment">// 通过判断子组件是否满足缓存匹配</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>\n          <span class="token comment">// not included</span>\n          <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>\n          <span class="token comment">// excluded</span>\n          <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword control-flow">return</span> vnode\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">var</span> ref$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> cache <span class="token operator">=</span> ref$<span class="token number">1.</span>cache<span class="token punctuation">;</span>\n        <span class="token keyword">var</span> keys <span class="token operator">=</span> ref$<span class="token number">1.</span>keys<span class="token punctuation">;</span>\n        <span class="token keyword">var</span> key <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">key</span> <span class="token operator">==</span> <span class="token keyword null nil">null</span> <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ctor</span></span><span class="token punctuation">.</span><span class="token property-access">cid</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">"::"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token operator">:</span> vnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">;</span>\n          <span class="token comment">// ==== 关注点在这里 ====</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 直接取出缓存组件</span>\n          vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n          <span class="token comment">// keys命中的组件名移到数组末端</span>\n          <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 初次渲染时，将vnode缓存</span>\n          cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n          keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token comment">// prune oldest entry</span>\n          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_vnode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword control-flow">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre>\n<p><code>render</code>函数前面逻辑可以参考前一篇文章，由于<code>cache</code>对象中存储了再次使用的<code>vnode</code>对象，所以直接通过<code>cache[key]</code>取出缓存的组件实例并赋值给<code>vnode</code>的<code>componentInstance</code>属性。可能在读到这里的时候，会对源码中<code>keys</code>这个数组的作用，以及<code>pruneCacheEntry</code>的功能有疑惑，这里我们放到文章末尾讲缓存优化策略时解答。</p>\n<h3 id="1363-%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%BF%E6%8D%A2">13.6.3 真实节点的替换<a class="anchor" href="#1363-%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%BF%E6%8D%A2">§</a></h3>\n<p>执行了<code>keep-alive</code>组件的<code>_render</code>过程，接下来是<code>_update</code>产生真实的节点，同样的，<code>keep-alive</code>下有<code>child1</code>子组件，所以<code>_update</code>过程会调用<code>createComponent</code>递归创建子组件<code>vnode</code>,这个过程在初次渲染时也有分析过，我们可以对比一下，再次渲染时流程有哪些不同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// vnode为缓存的vnode</span>\n      <span class="token keyword">var</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 此时isReactivated为true</span>\n        <span class="token keyword">var</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">;</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">init</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 其中一个作用是保留真实dom到vnode中</span>\n          <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword control-flow">return</span> <span class="token boolean">true</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre>\n<p><strong>此时的<code>vnode</code>是缓存取出的子组件<code>vnode</code></strong>，并且由于在第一次渲染时对组件进行了标记<code>vnode.data.keepAlive = true;</code>,所以<code>isReactivated</code>的值为<code>true</code>,<code>i.init</code>依旧会执行子组件的初始化过程。但是这个过程由于有缓存，所以执行过程也不完全相同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>\n        vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">&amp;&amp;</span>\n        <span class="token operator">!</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">.</span><span class="token property-access">_isDestroyed</span> <span class="token operator">&amp;&amp;</span>\n        vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span>\n      <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 当有keepAlive标志时，执行prepatch钩子</span>\n        <span class="token keyword">var</span> mountedNode <span class="token operator">=</span> vnode<span class="token punctuation">;</span> <span class="token comment">// work around flow</span>\n        componentVNodeHooks<span class="token punctuation">.</span><span class="token method function property-access">prepatch</span><span class="token punctuation">(</span>mountedNode<span class="token punctuation">,</span> mountedNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>\n          vnode<span class="token punctuation">,</span>\n          activeInstance\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        child<span class="token punctuation">.</span><span class="token method function property-access">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">:</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>显然因为有<code>keepAlive</code>的标志，所以子组件不再走挂载流程，只是执行<code>prepatch</code>钩子对组件状态进行更新。并且很好的利用了缓存<code>vnode</code>之前保留的真实节点进行节点的替换。</p>\n<h2 id="137-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">13.7 生命周期<a class="anchor" href="#137-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">§</a></h2>\n<p>我们通过例子来观察<code>keep-alive</code>生命周期和普通组件的不同。</p>\n<p><img src="./img/13.4.gif" alt=""></p>\n<p>在我们从<code>child1</code>切换到<code>child2</code>,再切回<code>child1</code>过程中，<code>chil1</code>不会再执行<code>mounted</code>钩子，只会执行<code>activated</code>钩子，而<code>child2</code>也不会执行<code>destoryed</code>钩子，只会执行<code>deactivated</code>钩子，这是为什么？<code>child2</code>的<code>deactivated</code>钩子又要比<code>child1</code>的<code>activated</code>提前执行，这又是为什么？</p>\n<h3 id="1371-deactivated">13.7.1 deactivated<a class="anchor" href="#1371-deactivated">§</a></h3>\n<p>我们先从组件的销毁开始说起，当<code>child1</code>切换到<code>child2</code>时，<code>child1</code>会执行<code>deactivated</code>钩子而不是<code>destoryed</code>钩子，这是为什么？\n前面分析<code>patch</code>过程会对新旧节点的改变进行对比，从而尽可能范围小的去操作真实节点，当完成<code>diff</code>算法并对节点操作完毕后，接下来还有一个重要的步骤是<strong>对旧的组件执行销毁移除操作</strong>。这一步的代码如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 分析过的patchVnode过程</span>\n  <span class="token comment">// 销毁旧节点</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">removeVnodes</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// startIdx,endIdx都为0</span>\n  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ch 会拿到需要销毁的组件</span>\n    <span class="token keyword">var</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 真实节点的移除操作</span>\n        <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span> <span class="token comment">// Text node</span>\n        <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p><code>removeAndInvokeRemoveHook</code>会对旧的节点进行移除操作，其中关键的一步是会将真实节点从父元素中删除，有兴趣可以自行查看这部分逻辑。<code>invokeDestroyHook</code>是执行销毁组件钩子的核心。如果该组件下存在子组件，会递归去调用<code>invokeDestroyHook</code>执行销毁操作。销毁过程会执行组件内部的<code>destory</code>钩子。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>\n    <span class="token keyword">var</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n      <span class="token comment">// 执行组件内部destroy钩子</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> cbs<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 如果组件存在子组件，则遍历子组件去递归调用invokeDestoryHook执行钩子</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n</code></pre>\n<p>组件内部钩子前面已经介绍了<code>init</code>和<code>prepatch</code>钩子，而<code>destroy</code>钩子的逻辑更加简单。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 组件实例</span>\n    <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果实例还未被销毁</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token property-access">_isDestroyed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 不是keep-alive组件则执行销毁操作</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        componentInstance<span class="token punctuation">.</span><span class="token method function property-access">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 如果是已经缓存的组件</span>\n        <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>当组件是<code>keep-alive</code>缓存过的组件，即已经用<code>keepAlive</code>标记过，则不会执行实例的销毁，即<code>componentInstance.$destroy()</code>的过程。<code>$destroy</code>过程会做一系列的组件销毁操作，其中的<code>beforeDestroy,destoryed</code>钩子也是在<code>$destory</code>过程中调用，而<code>deactivateChildComponent</code>的处理过程却完全不同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">deactivateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// </span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 已经被停用</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// 对子组件同样会执行停用处理</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 最终调用deactivated钩子</span>\n    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">\'deactivated\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p><code>_directInactive</code>是用来标记这个被打上停用标签的组件是否是最顶层的组件。而<code>_inactive</code>是停用的标志，同样的子组件也需要递归去调用<code>deactivateChildComponent</code>,打上停用的标记。<strong>最终会执行用户定义的<code>deactivated</code>钩子。</strong></p>\n<h3 id="1372-activated">13.7.2 activated<a class="anchor" href="#1372-activated">§</a></h3>\n<p>现在回过头看看<code>activated</code>的执行时机，同样是<code>patch</code>过程，在对旧节点移除并执行销毁或者停用的钩子后，对新节点也会执行相应的钩子。<strong>这也是停用的钩子比启用的钩子先执行的原因。</strong></p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// patchVnode过程</span>\n  <span class="token comment">// 销毁旧节点</span>\n  <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 执行组件内部的insert钩子</span>\n  <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">invokeInsertHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// delay insert hooks for component root nodes, invoke them after the</span>\n  <span class="token comment">// 当节点已经被插入时，会延迟执行insert钩子</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vnode<span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">pendingInsert</span> <span class="token operator">=</span> queue<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>同样的组件内部的<code>insert</code>钩子逻辑如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// 组件内部自带钩子</span>\n  <span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">insert</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> context <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">context</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token comment">// 实例已经被挂载</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token property-access">_isMounted</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        componentInstance<span class="token punctuation">.</span><span class="token property-access">_isMounted</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">\'mounted\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token property-access">_isMounted</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// vue-router#1212</span>\n          <span class="token comment">// During updates, a kept-alive component\'s child components may</span>\n          <span class="token comment">// change, so directly walking the tree here may call activated hooks</span>\n          <span class="token comment">// on incorrect children. Instead we push them into a queue which will</span>\n          <span class="token comment">// be processed after the whole patch process ended.</span>\n          <span class="token function">queueActivatedComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n          <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre>\n<p>当第一次实例化组件时，由于实例的<code>_isMounted</code>不存在，所以会调用<code>mounted</code>钩子，当我们从<code>child2</code>再次切回<code>child1</code>时，由于<code>child1</code>只是被停用而没有被销毁，所以不会再调用<code>mounted</code>钩子，此时会执行<code>activateChildComponent</code>函数对组件的状态进行处理。有了分析<code>deactivateChildComponent</code>的基础，<code>activateChildComponent</code>的逻辑也很好理解，同样的<code>_inactive</code>标记为已启用，并且对子组件递归调用<code>activateChildComponent</code>做状态处理。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">activateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">||</span> vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">===</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">\'activated\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="138-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96---lru">13.8 缓存优化 - LRU<a class="anchor" href="#138-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96---lru">§</a></h2>\n<p>程序的内存空间是有限的，所以我们无法无节制的对数据进行存储，这时候需要有策略去淘汰不那么重要的数据，保持最大数据存储量的一致。这种类型的策略称为缓存优化策略，根据淘汰的机制不同，常用的有以下三类。</p>\n<p><strong>1.FIFO： 先进先出策略，我们通过记录数据使用的时间，当缓存大小即将溢出时，优先清除离当前时间最远的数据。</strong></p>\n<p><strong>2.LRU： 最近最少使用。LRU策略遵循的原则是，如果数据最近被访问(使用)过，那么将来被访问的几率会更高，如果以一个数组去记录数据，当有一数据被访问时，该数据会被移动到数组的末尾，表明最近被使用过，当缓存溢出时，会删除数组的头部数据，即将最不频繁使用的数据移除。</strong></p>\n<p><strong>3.LFU: 计数最少策略。用次数去标记数据使用频率，次数最少的会在缓存溢出时被淘汰。</strong></p>\n<p>这三种缓存算法各有优劣，各自适用不同场景，而我们看<code>keep-alive</code>在缓存时的优化处理，很明显利用了<code>LRU</code>的缓存策略。我们看关键的代码</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n      keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_vnode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span> arr<span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>结合一个实际的例子分析缓存逻辑的实现。\n1.有三个组件<code>child1,child2,child3</code>,<code>keep-alive</code>的最大缓存个数设置为2\n2.用<code>cache</code>对象去存储组件<code>vnode</code>,<code>key</code>为组件名字，<code>value</code>为组件<code>vnode</code>对象，用<code>keys</code>数组去记录组件名字，由于是数组，所以<code>keys</code>为有序。\n3.<code>child1,child2</code>组件依次访问，缓存结果为</p>\n<pre class="language-js"><code class="language-js">keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'child1\'</span><span class="token punctuation">,</span> <span class="token string">\'child2\'</span><span class="token punctuation">]</span>\ncache <span class="token operator">=</span> <span class="token punctuation">{</span>\n  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>\n  child2<span class="token operator">:</span> child2Vnode\n<span class="token punctuation">}</span>\n</code></pre>\n<p>4.再次访问到<code>child1</code>组件，由于命中了缓存，会调用<code>remove</code>方法把<code>keys</code>中的<code>child1</code>删除，并通过数组的<code>push</code>方法将<code>child1</code>推到尾部。缓存结果修改为</p>\n<pre class="language-js"><code class="language-js">keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'child2\'</span><span class="token punctuation">,</span> <span class="token string">\'child1\'</span><span class="token punctuation">]</span>\ncache <span class="token operator">=</span> <span class="token punctuation">{</span>\n  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>\n  child2<span class="token operator">:</span> child2Vnode\n<span class="token punctuation">}</span>\n</code></pre>\n<p>5.访问到<code>child3</code>时，由于缓存个数限制，初次缓存会执行<code>pruneCacheEntry</code>方法对最少访问到的数据进行删除。<code>pruneCacheEntry</code>的定义如下</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">pruneCacheEntry</span> <span class="token punctuation">(</span><span class="token parameter">cache<span class="token punctuation">,</span>key<span class="token punctuation">,</span>keys<span class="token punctuation">,</span>current</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> cached###<span class="token number">1</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 销毁实例</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cached###<span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>current <span class="token operator">||</span> cached###<span class="token number">1.</span>tag <span class="token operator">!==</span> current<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      cached###<span class="token number">1.</span>componentInstance<span class="token punctuation">.</span><span class="token method function property-access">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>\n    <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n</code></pre>\n<p>删除缓存时会把<code>keys[0]</code>代表的组件删除，由于之前的处理，最近被访问到的元素会位于数组的尾部，所以头部的数据往往是最少访问的，因此会优先删除头部的元素。并且会再次调用<code>remove</code>方法，将<code>keys</code>的首个元素删除。</p>\n<p>这就是<code>vue</code>中对<code>keep-alive</code>缓存处理的优化过程。</p>'
        } }),
    'head': React.createElement(React.Fragment, null,
        React.createElement("link", { href: "/In-depth-analysis-of-Vue/src/assets/favicon.ico", rel: "icon" })),
    'script': React.createElement(React.Fragment, null,
        React.createElement("script", { src: "https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js" }),
        React.createElement("script", { src: "https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js" }),
        React.createElement("script", { src: "/In-depth-analysis-of-Vue/index.js", type: "module" })),
    'footer': React.createElement("footer", null,
        "Powered by\u00A0",
        React.createElement("a", { href: "https://github.com/xcatliu/pagic", target: "_blank" }, "Pagic")),
    'contentTitle': undefined,
    'contentBody': React.createElement("article", { dangerouslySetInnerHTML: {
            __html: '<blockquote>\n<p>上一节，我们对<code>keep-alive</code>组件的初始渲染流程以及组件的配置信息进行了源码分析。初始渲染流程最关键的一步是对渲染的组件<code>Vnode</code>进行缓存，其中也包括了组件的真实节点存储。有了第一次的缓存，当再次渲染组件时，<code>keep-alive</code>又拥有哪些魔法呢？接下来我们将彻底揭开这一层面纱。</p>\n</blockquote>\n<h2 id="135-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">13.5 准备工作<a class="anchor" href="#135-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">§</a></h2>\n<p>上一节对<code>keep-alive</code>组件的分析，是从我画的一个流程图开始的。如果不想回过头看上一节的内容，可以参考以下的简单总结。</p>\n<ol>\n<li><code>keep-alive</code>是源码内部定义的组件选项配置，它会先注册为全局组件供开发者全局使用，其中<code>render</code>函数定义了它的渲染过程</li>\n<li>和普通组件一致，当父在创建真实节点的过程中，遇到<code>keep-alive</code>的组件会进行组件的初始化和实例化。</li>\n<li>实例化会执行挂载<code>$mount</code>的过程，这一步会执行<code>keep-alive</code>选项中的<code>render</code>函数。</li>\n<li><code>render</code>函数在初始渲染时，会将渲染的子<code>Vnode</code>进行缓存。同时<strong>对应的子真实节点也会被缓存起来</strong>。</li>\n</ol>\n<p>那么，当再次需要渲染到已经被渲染过的组件时，<code>keep-alive</code>的处理又有什么不同呢？</p>\n<h3 id="1351-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">13.5.1 基础使用<a class="anchor" href="#1351-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">§</a></h3>\n<p>为了文章的完整性，我依旧把基础的使用展示出来，其中加入了生命周期的使用，方便后续对<code>keep-alive</code>生命周期的分析。</p>\n<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changeTabs(<span class="token punctuation">\'</span>child1<span class="token punctuation">\'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>child1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changeTabs(<span class="token punctuation">\'</span>child2<span class="token punctuation">\'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>child2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">></span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chooseTabs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n</code></pre>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token punctuation">{</span>\n    template<span class="token operator">:</span> <span class="token string">\'&lt;div>&lt;button @click="add">add&lt;/button>&lt;p>{{num}}&lt;/p>&lt;/div>\'</span><span class="token punctuation">,</span>\n    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>\n            num<span class="token operator">:</span> <span class="token number">1</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    methods<span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token operator">++</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 mounted\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 activated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 deactivated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child1 destoryed\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> child2 <span class="token operator">=</span> <span class="token punctuation">{</span>\n    template<span class="token operator">:</span> <span class="token string">\'&lt;div>child2&lt;/div>\'</span><span class="token punctuation">,</span>\n    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 mounted\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 activated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 deactivated\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">\'child2 destoryed\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    el<span class="token operator">:</span> <span class="token string">\'#app\'</span><span class="token punctuation">,</span>\n    components<span class="token operator">:</span> <span class="token punctuation">{</span>\n        child1<span class="token punctuation">,</span>\n        child2<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>\n            chooseTabs<span class="token operator">:</span> <span class="token string">\'child1\'</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    methods<span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">changeTabs</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">chooseTabs</span> <span class="token operator">=</span> tab<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<h3 id="1352-%E6%B5%81%E7%A8%8B%E5%9B%BE">13.5.2 流程图<a class="anchor" href="#1352-%E6%B5%81%E7%A8%8B%E5%9B%BE">§</a></h3>\n<p>和首次渲染的分析一致，再次渲染的过程我依旧画了一个简单的流程图。</p>\n<p><img src="./img/13.3.png" alt=""></p>\n<h2 id="136-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">13.6 流程分析<a class="anchor" href="#136-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">§</a></h2>\n<h3 id="1361-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6">13.6.1 重新渲染组件<a class="anchor" href="#1361-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6">§</a></h3>\n<p>再次渲染的流程从数据改变说起，在这个例子中，动态组件中<code>chooseTabs</code>数据的变化会引起依赖派发更新的过程(这个系列有三篇文章详细介绍了vue响应式系统的底层实现，感兴趣的同学可以借鉴)。简单来说，<code>chooseTabs</code>这个数据在初始化阶段会收集使用到该数据的相关依赖。当数据发生改变时，收集过的依赖会进行派发更新操作。</p>\n<p>其中，父组件中负责实例挂载的过程作为依赖会被执行，即执行父组件的<code>vm._update(vm._render(), hydrating);</code>。<code>_render</code>和<code>_update</code>分别代表两个过程，其中<code>_render</code>函数会根据数据的变化为组件生成新的<code>Vnode</code>节点，而<code>_update</code>最终会为新的<code>Vnode</code>生成真实的节点。而在生成真实节点的过程中，会利用<code>vitrual dom</code>的<code>diff</code>算法对前后<code>vnode</code>节点进行对比，使之尽可能少的更改真实节点，这一部分内容可以回顾<a href="https://juejin.im/post/5d3967a56fb9a07efc49cca1">深入剖析Vue源码 - 来，跟我一起实现diff算法!</a>，里面详细阐述了利用<code>diff</code>算法进行节点差异对比的思路。</p>\n<p><code>patch</code>是新旧<code>Vnode</code>节点对比的过程，而<code>patchVnode</code>是其中核心的步骤，我们忽略<code>patchVnode</code>其他的流程，关注到其中对子组件执行<code>prepatch</code>钩子的过程中。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">,</span>insertedVnodeQueue<span class="token punctuation">,</span>ownerArray<span class="token punctuation">,</span>index<span class="token punctuation">,</span>removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token comment">// 新vnode  执行prepatch钩子</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">prepatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    ···\n<span class="token punctuation">}</span>\n</code></pre>\n<p>执行<code>prepatch</code>钩子时会拿到新旧组件的实例并执行<code>updateChildComponent</code>函数。而<code>updateChildComponent</code>会对针对新的组件实例对旧实例进行状态的更新，包括<code>props,listeners</code>等，最终会<strong>调用<code>vue</code>提供的全局<code>vm.$forceUpdate()</code>方法进行实例的重新渲染。</strong></p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 之前分析的init钩子 </span>\n    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">prepatch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">prepatch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 新组件实例</span>\n      <span class="token keyword">var</span> options <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentOptions</span><span class="token punctuation">;</span>\n      <span class="token comment">// 旧组件实例</span>\n      <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token function">updateChildComponent</span><span class="token punctuation">(</span>\n        child<span class="token punctuation">,</span>\n        options<span class="token punctuation">.</span><span class="token property-access">propsData</span><span class="token punctuation">,</span> <span class="token comment">// updated props</span>\n        options<span class="token punctuation">.</span><span class="token property-access">listeners</span><span class="token punctuation">,</span> <span class="token comment">// updated listeners</span>\n        vnode<span class="token punctuation">,</span> <span class="token comment">// new parent vnode</span>\n        options<span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token comment">// new children</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">updateChildComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 更新旧的状态，不分析这个过程</span>\n    ···\n    <span class="token comment">// 迫使实例重新渲染。</span>\n    vm<span class="token punctuation">.</span><span class="token method function property-access">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>先看看<code>$forceUpdate</code>做了什么操作。<code>$forceUpdate</code>是源码对外暴露的一个api，他们迫使<code>Vue</code>实例重新渲染，本质上是执行实例所收集的依赖，在例子中<code>watcher</code>对应的是<code>keep-alive</code>的<code>vm._update(vm._render(), hydrating);</code>过程。</p>\n<pre class="language-js"><code class="language-js"><span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      vm<span class="token punctuation">.</span><span class="token property-access">_watcher</span><span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre>\n<h3 id="1362-%E9%87%8D%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6">13.6.2 重用缓存组件<a class="anchor" href="#1362-%E9%87%8D%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6">§</a></h3>\n<p>由于<code>vm.$forceUpdate()</code>会强迫<code>keep-alive</code>组件进行重新渲染，因此<code>keep-alive</code>组件会再一次执行<code>render</code>过程。这一次由于第一次对<code>vnode</code>的缓存，<code>keep-alive</code>在实例的<code>cache</code>对象中找到了缓存的组件。</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// keepalive组件选项</span>\n<span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token string">\'keep-alive\'</span><span class="token punctuation">,</span>\n    abstract<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 拿到keep-alive下插槽的值</span>\n      <span class="token keyword">var</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">$slots</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>\n      <span class="token comment">// 第一个vnode节点</span>\n      <span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 拿到第一个组件实例</span>\n      <span class="token keyword">var</span> componentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentOptions</span><span class="token punctuation">;</span>\n      <span class="token comment">// keep-alive的第一个子组件实例存在</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// check pattern</span>\n        <span class="token comment">//拿到第一个vnode节点的name</span>\n        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> include <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">include</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> exclude <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">exclude</span><span class="token punctuation">;</span>\n        <span class="token comment">// 通过判断子组件是否满足缓存匹配</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>\n          <span class="token comment">// not included</span>\n          <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>\n          <span class="token comment">// excluded</span>\n          <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword control-flow">return</span> vnode\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">var</span> ref$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> cache <span class="token operator">=</span> ref$<span class="token number">1.</span>cache<span class="token punctuation">;</span>\n        <span class="token keyword">var</span> keys <span class="token operator">=</span> ref$<span class="token number">1.</span>keys<span class="token punctuation">;</span>\n        <span class="token keyword">var</span> key <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">key</span> <span class="token operator">==</span> <span class="token keyword null nil">null</span> <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ctor</span></span><span class="token punctuation">.</span><span class="token property-access">cid</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span><span class="token property-access">tag</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">"::"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token operator">:</span> vnode<span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">;</span>\n          <span class="token comment">// ==== 关注点在这里 ====</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 直接取出缓存组件</span>\n          vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n          <span class="token comment">// keys命中的组件名移到数组末端</span>\n          <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 初次渲染时，将vnode缓存</span>\n          cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n          keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token comment">// prune oldest entry</span>\n          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_vnode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword control-flow">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre>\n<p><code>render</code>函数前面逻辑可以参考前一篇文章，由于<code>cache</code>对象中存储了再次使用的<code>vnode</code>对象，所以直接通过<code>cache[key]</code>取出缓存的组件实例并赋值给<code>vnode</code>的<code>componentInstance</code>属性。可能在读到这里的时候，会对源码中<code>keys</code>这个数组的作用，以及<code>pruneCacheEntry</code>的功能有疑惑，这里我们放到文章末尾讲缓存优化策略时解答。</p>\n<h3 id="1363-%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%BF%E6%8D%A2">13.6.3 真实节点的替换<a class="anchor" href="#1363-%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%BF%E6%8D%A2">§</a></h3>\n<p>执行了<code>keep-alive</code>组件的<code>_render</code>过程，接下来是<code>_update</code>产生真实的节点，同样的，<code>keep-alive</code>下有<code>child1</code>子组件，所以<code>_update</code>过程会调用<code>createComponent</code>递归创建子组件<code>vnode</code>,这个过程在初次渲染时也有分析过，我们可以对比一下，再次渲染时流程有哪些不同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// vnode为缓存的vnode</span>\n      <span class="token keyword">var</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 此时isReactivated为true</span>\n        <span class="token keyword">var</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">;</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">init</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 其中一个作用是保留真实dom到vnode中</span>\n          <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword control-flow">return</span> <span class="token boolean">true</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre>\n<p><strong>此时的<code>vnode</code>是缓存取出的子组件<code>vnode</code></strong>，并且由于在第一次渲染时对组件进行了标记<code>vnode.data.keepAlive = true;</code>,所以<code>isReactivated</code>的值为<code>true</code>,<code>i.init</code>依旧会执行子组件的初始化过程。但是这个过程由于有缓存，所以执行过程也不完全相同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>\n        vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">&amp;&amp;</span>\n        <span class="token operator">!</span>vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">.</span><span class="token property-access">_isDestroyed</span> <span class="token operator">&amp;&amp;</span>\n        vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span>\n      <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 当有keepAlive标志时，执行prepatch钩子</span>\n        <span class="token keyword">var</span> mountedNode <span class="token operator">=</span> vnode<span class="token punctuation">;</span> <span class="token comment">// work around flow</span>\n        componentVNodeHooks<span class="token punctuation">.</span><span class="token method function property-access">prepatch</span><span class="token punctuation">(</span>mountedNode<span class="token punctuation">,</span> mountedNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>\n          vnode<span class="token punctuation">,</span>\n          activeInstance\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        child<span class="token punctuation">.</span><span class="token method function property-access">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span><span class="token property-access">elm</span> <span class="token operator">:</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>显然因为有<code>keepAlive</code>的标志，所以子组件不再走挂载流程，只是执行<code>prepatch</code>钩子对组件状态进行更新。并且很好的利用了缓存<code>vnode</code>之前保留的真实节点进行节点的替换。</p>\n<h2 id="137-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">13.7 生命周期<a class="anchor" href="#137-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">§</a></h2>\n<p>我们通过例子来观察<code>keep-alive</code>生命周期和普通组件的不同。</p>\n<p><img src="./img/13.4.gif" alt=""></p>\n<p>在我们从<code>child1</code>切换到<code>child2</code>,再切回<code>child1</code>过程中，<code>chil1</code>不会再执行<code>mounted</code>钩子，只会执行<code>activated</code>钩子，而<code>child2</code>也不会执行<code>destoryed</code>钩子，只会执行<code>deactivated</code>钩子，这是为什么？<code>child2</code>的<code>deactivated</code>钩子又要比<code>child1</code>的<code>activated</code>提前执行，这又是为什么？</p>\n<h3 id="1371-deactivated">13.7.1 deactivated<a class="anchor" href="#1371-deactivated">§</a></h3>\n<p>我们先从组件的销毁开始说起，当<code>child1</code>切换到<code>child2</code>时，<code>child1</code>会执行<code>deactivated</code>钩子而不是<code>destoryed</code>钩子，这是为什么？\n前面分析<code>patch</code>过程会对新旧节点的改变进行对比，从而尽可能范围小的去操作真实节点，当完成<code>diff</code>算法并对节点操作完毕后，接下来还有一个重要的步骤是<strong>对旧的组件执行销毁移除操作</strong>。这一步的代码如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 分析过的patchVnode过程</span>\n  <span class="token comment">// 销毁旧节点</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">removeVnodes</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// startIdx,endIdx都为0</span>\n  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ch 会拿到需要销毁的组件</span>\n    <span class="token keyword">var</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 真实节点的移除操作</span>\n        <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span> <span class="token comment">// Text node</span>\n        <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token property-access">elm</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p><code>removeAndInvokeRemoveHook</code>会对旧的节点进行移除操作，其中关键的一步是会将真实节点从父元素中删除，有兴趣可以自行查看这部分逻辑。<code>invokeDestroyHook</code>是执行销毁组件钩子的核心。如果该组件下存在子组件，会递归去调用<code>invokeDestroyHook</code>执行销毁操作。销毁过程会执行组件内部的<code>destory</code>钩子。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>\n    <span class="token keyword">var</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n      <span class="token comment">// 执行组件内部destroy钩子</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> cbs<span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 如果组件存在子组件，则遍历子组件去递归调用invokeDestoryHook执行钩子</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n</code></pre>\n<p>组件内部钩子前面已经介绍了<code>init</code>和<code>prepatch</code>钩子，而<code>destroy</code>钩子的逻辑更加简单。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 组件实例</span>\n    <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果实例还未被销毁</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token property-access">_isDestroyed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 不是keep-alive组件则执行销毁操作</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        componentInstance<span class="token punctuation">.</span><span class="token method function property-access">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 如果是已经缓存的组件</span>\n        <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>当组件是<code>keep-alive</code>缓存过的组件，即已经用<code>keepAlive</code>标记过，则不会执行实例的销毁，即<code>componentInstance.$destroy()</code>的过程。<code>$destroy</code>过程会做一系列的组件销毁操作，其中的<code>beforeDestroy,destoryed</code>钩子也是在<code>$destory</code>过程中调用，而<code>deactivateChildComponent</code>的处理过程却完全不同。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">deactivateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// </span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 已经被停用</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// 对子组件同样会执行停用处理</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 最终调用deactivated钩子</span>\n    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">\'deactivated\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p><code>_directInactive</code>是用来标记这个被打上停用标签的组件是否是最顶层的组件。而<code>_inactive</code>是停用的标志，同样的子组件也需要递归去调用<code>deactivateChildComponent</code>,打上停用的标记。<strong>最终会执行用户定义的<code>deactivated</code>钩子。</strong></p>\n<h3 id="1372-activated">13.7.2 activated<a class="anchor" href="#1372-activated">§</a></h3>\n<p>现在回过头看看<code>activated</code>的执行时机，同样是<code>patch</code>过程，在对旧节点移除并执行销毁或者停用的钩子后，对新节点也会执行相应的钩子。<strong>这也是停用的钩子比启用的钩子先执行的原因。</strong></p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// patchVnode过程</span>\n  <span class="token comment">// 销毁旧节点</span>\n  <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 执行组件内部的insert钩子</span>\n  <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">invokeInsertHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// delay insert hooks for component root nodes, invoke them after the</span>\n  <span class="token comment">// 当节点已经被插入时，会延迟执行insert钩子</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vnode<span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">pendingInsert</span> <span class="token operator">=</span> queue<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">hook</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>同样的组件内部的<code>insert</code>钩子逻辑如下：</p>\n<pre class="language-js"><code class="language-js"><span class="token comment">// 组件内部自带钩子</span>\n  <span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">insert</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> context <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">context</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token comment">// 实例已经被挂载</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token property-access">_isMounted</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        componentInstance<span class="token punctuation">.</span><span class="token property-access">_isMounted</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">\'mounted\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">keepAlive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token property-access">_isMounted</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// vue-router#1212</span>\n          <span class="token comment">// During updates, a kept-alive component\'s child components may</span>\n          <span class="token comment">// change, so directly walking the tree here may call activated hooks</span>\n          <span class="token comment">// on incorrect children. Instead we push them into a queue which will</span>\n          <span class="token comment">// be processed after the whole patch process ended.</span>\n          <span class="token function">queueActivatedComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n          <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre>\n<p>当第一次实例化组件时，由于实例的<code>_isMounted</code>不存在，所以会调用<code>mounted</code>钩子，当我们从<code>child2</code>再次切回<code>child1</code>时，由于<code>child1</code>只是被停用而没有被销毁，所以不会再调用<code>mounted</code>钩子，此时会执行<code>activateChildComponent</code>函数对组件的状态进行处理。有了分析<code>deactivateChildComponent</code>的基础，<code>activateChildComponent</code>的逻辑也很好理解，同样的<code>_inactive</code>标记为已启用，并且对子组件递归调用<code>activateChildComponent</code>做状态处理。</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">activateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_directInactive</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword control-flow">return</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">||</span> vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">===</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    vm<span class="token punctuation">.</span><span class="token property-access">_inactive</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token property-access">$children</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">\'activated\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<h2 id="138-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96---lru">13.8 缓存优化 - LRU<a class="anchor" href="#138-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96---lru">§</a></h2>\n<p>程序的内存空间是有限的，所以我们无法无节制的对数据进行存储，这时候需要有策略去淘汰不那么重要的数据，保持最大数据存储量的一致。这种类型的策略称为缓存优化策略，根据淘汰的机制不同，常用的有以下三类。</p>\n<p><strong>1.FIFO： 先进先出策略，我们通过记录数据使用的时间，当缓存大小即将溢出时，优先清除离当前时间最远的数据。</strong></p>\n<p><strong>2.LRU： 最近最少使用。LRU策略遵循的原则是，如果数据最近被访问(使用)过，那么将来被访问的几率会更高，如果以一个数组去记录数据，当有一数据被访问时，该数据会被移动到数组的末尾，表明最近被使用过，当缓存溢出时，会删除数组的头部数据，即将最不频繁使用的数据移除。</strong></p>\n<p><strong>3.LFU: 计数最少策略。用次数去标记数据使用频率，次数最少的会在缓存溢出时被淘汰。</strong></p>\n<p>这三种缓存算法各有优劣，各自适用不同场景，而我们看<code>keep-alive</code>在缓存时的优化处理，很明显利用了<code>LRU</code>的缓存策略。我们看关键的代码</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ···\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      vnode<span class="token punctuation">.</span><span class="token property-access">componentInstance</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">componentInstance</span><span class="token punctuation">;</span>\n      <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>\n      cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>\n      keys<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">max</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_vnode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword control-flow">return</span> arr<span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>结合一个实际的例子分析缓存逻辑的实现。\n1.有三个组件<code>child1,child2,child3</code>,<code>keep-alive</code>的最大缓存个数设置为2\n2.用<code>cache</code>对象去存储组件<code>vnode</code>,<code>key</code>为组件名字，<code>value</code>为组件<code>vnode</code>对象，用<code>keys</code>数组去记录组件名字，由于是数组，所以<code>keys</code>为有序。\n3.<code>child1,child2</code>组件依次访问，缓存结果为</p>\n<pre class="language-js"><code class="language-js">keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'child1\'</span><span class="token punctuation">,</span> <span class="token string">\'child2\'</span><span class="token punctuation">]</span>\ncache <span class="token operator">=</span> <span class="token punctuation">{</span>\n  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>\n  child2<span class="token operator">:</span> child2Vnode\n<span class="token punctuation">}</span>\n</code></pre>\n<p>4.再次访问到<code>child1</code>组件，由于命中了缓存，会调用<code>remove</code>方法把<code>keys</code>中的<code>child1</code>删除，并通过数组的<code>push</code>方法将<code>child1</code>推到尾部。缓存结果修改为</p>\n<pre class="language-js"><code class="language-js">keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'child2\'</span><span class="token punctuation">,</span> <span class="token string">\'child1\'</span><span class="token punctuation">]</span>\ncache <span class="token operator">=</span> <span class="token punctuation">{</span>\n  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>\n  child2<span class="token operator">:</span> child2Vnode\n<span class="token punctuation">}</span>\n</code></pre>\n<p>5.访问到<code>child3</code>时，由于缓存个数限制，初次缓存会执行<code>pruneCacheEntry</code>方法对最少访问到的数据进行删除。<code>pruneCacheEntry</code>的定义如下</p>\n<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">pruneCacheEntry</span> <span class="token punctuation">(</span><span class="token parameter">cache<span class="token punctuation">,</span>key<span class="token punctuation">,</span>keys<span class="token punctuation">,</span>current</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> cached###<span class="token number">1</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 销毁实例</span>\n    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>cached###<span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>current <span class="token operator">||</span> cached###<span class="token number">1.</span>tag <span class="token operator">!==</span> current<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      cached###<span class="token number">1.</span>componentInstance<span class="token punctuation">.</span><span class="token method function property-access">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>\n    <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n</code></pre>\n<p>删除缓存时会把<code>keys[0]</code>代表的组件删除，由于之前的处理，最近被访问到的元素会位于数组的尾部，所以头部的数据往往是最少访问的，因此会优先删除头部的元素。并且会再次调用<code>remove</code>方法，将<code>keys</code>的首个元素删除。</p>\n<p>这就是<code>vue</code>中对<code>keep-alive</code>缓存处理的优化过程。</p>'
        } }),
    'toc': React.createElement("nav", { key: "0", className: "toc" },
        React.createElement("ol", null,
            React.createElement("li", null,
                React.createElement("a", { href: "#135-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" }, "13.5 \u51C6\u5907\u5DE5\u4F5C"),
                React.createElement("ol", null,
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1351-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8" }, "13.5.1 \u57FA\u7840\u4F7F\u7528")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1352-%E6%B5%81%E7%A8%8B%E5%9B%BE" }, "13.5.2 \u6D41\u7A0B\u56FE")))),
            React.createElement("li", null,
                React.createElement("a", { href: "#136-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90" }, "13.6 \u6D41\u7A0B\u5206\u6790"),
                React.createElement("ol", null,
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1361-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6" }, "13.6.1 \u91CD\u65B0\u6E32\u67D3\u7EC4\u4EF6")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1362-%E9%87%8D%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6" }, "13.6.2 \u91CD\u7528\u7F13\u5B58\u7EC4\u4EF6")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1363-%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%BF%E6%8D%A2" }, "13.6.3 \u771F\u5B9E\u8282\u70B9\u7684\u66FF\u6362")))),
            React.createElement("li", null,
                React.createElement("a", { href: "#137-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" }, "13.7 \u751F\u547D\u5468\u671F"),
                React.createElement("ol", null,
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1371-deactivated" }, "13.7.1 deactivated")),
                    React.createElement("li", null,
                        React.createElement("a", { href: "#1372-activated" }, "13.7.2 activated")))),
            React.createElement("li", null,
                React.createElement("a", { href: "#138-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96---lru" }, "13.8 \u7F13\u5B58\u4F18\u5316 - LRU")))),
    'author': "wyp",
    'contributors': [
        "wyp"
    ],
    'date': "2019-10-29T06:12:00.000Z",
    'updated': "2019-10-30T09:03:02.000Z",
    'excerpt': "13.5 准备工作 上一节对keep-alive组件的分析，是从我画的一个流程图开始的。如果不想回过头看上一节的内容，可以参考以下的简单总结。 1. keep-alive是源码内部定义的组件选项配置，它会先注册为全局组件供开发者全局使用，其...",
    'cover': "./img/13.3.png",
    'sidebar': [
        {
            "text": "1.丰富的选项合并策略",
            "link": "/In-depth-analysis-of-Vue/src/1.丰富的选项合并策略.md"
        },
        {
            "text": "2.基础的数据代理检测",
            "link": "/In-depth-analysis-of-Vue/src/2.基础的数据代理检测.md"
        },
        {
            "text": "3.实例挂载流程和模板编译",
            "link": "/In-depth-analysis-of-Vue/src/3.实例挂载流程和模板编译.md"
        },
        {
            "text": "4.完整渲染流程",
            "link": "/In-depth-analysis-of-Vue/src/4.完整渲染流程.md"
        },
        {
            "text": "5.组件基础剖析",
            "link": "/In-depth-analysis-of-Vue/src/5.组件基础剖析.md"
        },
        {
            "text": "6.组件高级用法",
            "link": "/In-depth-analysis-of-Vue/src/6.组件高级用法.md"
        },
        {
            "text": "7.深入响应式系统构建-上",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-上.md"
        },
        {
            "text": "7.深入响应式系统构建-中",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-中.md"
        },
        {
            "text": "7.深入响应式系统构建-下",
            "link": "/In-depth-analysis-of-Vue/src/7.深入响应式系统构建-下.md"
        },
        {
            "text": "8.来，跟我一起实现diff算法",
            "link": "/In-depth-analysis-of-Vue/src/8.来，跟我一起实现diff算法.md"
        },
        {
            "text": "9.揭秘Vue的事件机制",
            "link": "/In-depth-analysis-of-Vue/src/9.揭秘Vue的事件机制.md"
        },
        {
            "text": "10.vue插槽，你想了解的都在这里",
            "link": "/In-depth-analysis-of-Vue/src/10.vue插槽，你想了解的都在这里.md"
        },
        {
            "text": "11.你真的了解v-model的语法糖了吗",
            "link": "/In-depth-analysis-of-Vue/src/11.你真的了解v-model的语法糖了吗.md"
        },
        {
            "text": "12.动态组件的深入分析",
            "link": "/In-depth-analysis-of-Vue/src/12.动态组件的深入分析.md"
        },
        {
            "text": "13.彻底搞懂Vue中keep-alive的魔法-上",
            "link": "/In-depth-analysis-of-Vue/src/13.彻底搞懂Vue中keep-alive的魔法-上.md"
        },
        {
            "text": "13.彻底搞懂Vue中keep-alive的魔法-下",
            "link": "/In-depth-analysis-of-Vue/src/13.彻底搞懂Vue中keep-alive的魔法-下.md"
        }
    ]
};
